<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Master Data Bukti TF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Modal PIN -->
  <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-80 text-center">
      <h2 class="text-xl font-bold text-indigo-700 mb-4">Masukkan PIN</h2>
      <input id="pinInput" type="password" maxlength="6" placeholder="******"
             class="w-full border p-2 rounded-xl text-center tracking-widest text-lg"/>
      <p id="pinError" class="text-red-500 text-sm mt-2 hidden">PIN salah, coba lagi!</p>
      <button id="pinSubmit" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl">
        Masuk
      </button>
      </div>
  </div>
</head>
<body class="bg-gradient-to-br from-cyan-100 to-blue-200 min-h-screen p-2 sm:p-4">
  <!-- Spinner -->
  <div class="spinner fixed top-1/2 left-1/2 w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin z-50" id="loadingSpinner"></div>

  <div class="flex flex-col sm:flex-row gap-4">
    <!-- Sidebar -->
    <aside class="bg-white rounded-xl shadow-md p-4 w-full sm:w-64">
      <a href="dashboard.html" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg mb-4 shadow">Dashboard</a>
      <h3 class="text-lg font-semibold text-blue-600 mb-2">Daftar Pos</h3>
      <ul id="posList" class="space-y-2 text-blue-600"></ul>
    </aside>

    <!-- Main content -->
    <main class="flex-1 bg-white rounded-xl shadow-md p-4">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Master Data Bukti TF Pangkalan</h2>
      <div class="flex flex-wrap gap-3 items-end mb-4">
        <label class="flex flex-col text-sm text-gray-700">
          Mulai:
          <input type="date" id="startDate" class="border rounded-md px-2 py-1 mt-1" />
        </label>
        <label class="flex flex-col text-sm text-gray-700">
          Selesai:
          <input type="date" id="endDate" class="border rounded-md px-2 py-1 mt-1" />
        </label>
        <button class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow" id="filterBtn">Filter</button>
        <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow" id="resetBtn">Reset</button>
      </div>

      <!-- Table -->
      <div class="overflow-auto rounded-xl border border-gray-200">
        <table id="ledgerTable" class="min-w-[900px] w-full text-sm text-left text-gray-700">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="p-2">Timestamp</th>
              <th class="p-2">Pembayaran</th>
              <th class="p-3">Nama Pangkalan</th>
              <th class="p-3">Nama PT</th>
              <th class="p-3">Nominal</th>
              <th class="p-3">Foto Nota</th>
              <th class="p-3">Pembayaran</th>
              <th class="p-3">Bukti Serah Terima</th>
              <th class="p-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="ledgerTableBody" class="bg-white"></tbody>
        </table>
        <div id="totalNominal" class="font-semibold text-right p-4 text-blue-600">Total Nominal: Rp 0</div>
      </div>
    </main>
  </div>

<!-- Modal Edit -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-semibold mb-4">Edit Transaksi</h3>
    <form id="editForm" class="space-y-3">
      <input type="hidden" id="editRow" />
       <label class="block">
        <span class="text-sm">Timestamp</span>
        <!-- ✅ Format text manual -->
        <input type="text" id="editTimestamp" placeholder="dd/MM/yyyy HH:mm:ss" class="w-full border rounded px-2 py-1" />
      </label>
      <label class="block">
        <span class="text-sm">Nama</span>
        <input type="text" id="editNama" class="w-full border rounded px-2 py-1" />
      </label>
      <label class="block">
        <span class="text-sm">Uraian</span>
        <input type="text" id="editUraian" class="w-full border rounded px-2 py-1" />
      </label>
      <label class="block">
        <span class="text-sm">Pos</span>
        <input type="text" id="editPos" class="w-full border rounded px-2 py-1" />
      </label>
      <label class="block">
        <span class="text-sm">Nominal</span>
        <input type="number" id="editNominal" class="w-full border rounded px-2 py-1" />
      </label>
      <label class="block">
        <span class="text-sm">Pembayaran</span>
        <select id="editPembayaran" class="w-full border rounded px-2 py-1">
          <option value="Cash">Cash</option>
          <option value="Transfer">Transfer</option>
        </select>
      </label>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-400 hover:bg-gray-500 text-white">Batal</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Simpan</button>
      </div>
    </form>
  </div>
</div>


  <script src="config.js"></script>
  <style>
    #ledgerTable td img { max-width: 50px; max-height: 50px; border-radius: 0.5rem; border: 1px solid #ddd; padding: 2px; background: #fff; }
    .pos-active { background-color: #2563eb !important; color: white !important; font-weight: bold; border-radius: 0.5rem; padding: 0.25rem 0.5rem; }
    #posList li { cursor: pointer; padding: 6px 12px; border-radius: 0.5rem; transition: background-color 0.2s; }
    #posList li:hover { background-color: #ebf4ff; }
  </style>

  <script>
    // ===== PIN Handling =====
    const CORRECT_PIN = "220822";
    const pinModal = document.getElementById("pinModal");
    const pinInput = document.getElementById("pinInput");
    const pinSubmit = document.getElementById("pinSubmit");
    const pinError = document.getElementById("pinError");
    const pageContent = document.getElementById("pageContent");

    pinSubmit.addEventListener("click", () => {
      if (pinInput.value === CORRECT_PIN) {
        pinModal.style.display = "none";
        pageContent.classList.remove("hidden");
      } else {
        pinError.classList.remove("hidden");
        pinInput.value = "";
        pinInput.focus();
      }
    });

    pinInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") pinSubmit.click();
    });

    // ===== Existing Script (fetch, edit, etc) =====

     let allData = [];
  let selectedItem = null;

  // ✅ Cek login
  if (localStorage.getItem('loggedIn') !== 'true') window.location.href = 'login.html';
  const id_spreadsheet = localStorage.getItem("id_spreadsheet");
  if (!id_spreadsheet) { 
    alert("Spreadsheet ID tidak ditemukan. Silakan login ulang."); 
    window.location.href = "login.html"; 
  }

  const endpoint = `${API_ENDPOINT}?action=transaksi&id_spreadsheet=${id_spreadsheet}`;
  const posEndpoint = `${API_ENDPOINT}?action=namapos&id_spreadsheet=${id_spreadsheet}`;

  // ✅ Auto set tanggal: awal bulan sampai hari ini
  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    const pad = n => n.toString().padStart(2, "0");

    const firstDay = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-01`;
    const todayStr = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;

    document.getElementById("startDate").value = firstDay;
    document.getElementById("endDate").value = todayStr;
  });

  function formatRupiah(angka) {
    const num = parseInt(angka.toString().replace(/[^\d]/g, ""));
    return isNaN(num) ? "" : num.toLocaleString("id-ID", { style: "currency", currency: "IDR" });
  }

  function formatTanggalIndonesia(datetimeStr) {
    const date = new Date(datetimeStr);
    if (isNaN(date)) return datetimeStr;
    const pad = n => n.toString().padStart(2, '0');
    return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
  }

  function extractDriveId(url) {
    const match = url.match(/[-\w]{25,}/);
    return match ? match[0] : "";
  }

async function fetchData() {
  document.getElementById("loadingSpinner").style.display = "block";
  try {
    const res = await fetch(endpoint);
    const rawData = await res.json();

    // tambahin row index manual (baris 1 = header, data mulai baris 2)
    allData = rawData.map((item, i) => ({
      ...item,
      row: i + 2
    }));

    filterByDate(); // langsung pake filter sesuai tanggal input
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


  async function fetchPos() {
    const res = await fetch(posEndpoint);
    const allPos = await res.json();
    const posList = document.getElementById("posList");
    posList.innerHTML = "";
    allPos.forEach(pos => {
      const li = document.createElement("li");
      li.textContent = pos.nama_pos;
      li.onclick = () => filterByPos(pos.nama_pos);
      posList.appendChild(li);
    });
  }


    function renderTable(data) {
      const tbody = document.getElementById("ledgerTableBody");
      tbody.innerHTML = "";
      let totalNominal = 0;

      data.forEach((item, index) => {
        const nominal = item.nominal ? parseInt(item.nominal) : 0;
        totalNominal += nominal;

const fotoNota = item.foto && item.foto.includes('https://') 
  ? `<a href="${item.foto}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${extractDriveId(item.foto)}&sz=w200" alt="Foto Nota" /></a>` 
  : '<span class="error">-</span>';

const buktitransfer = item.buktitransfer && item.buktitransfer.includes('https://') 
  ? `<a href="${item.buktitransfer}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${extractDriveId(item.buktitransfer)}&sz=w200" alt="Bukti Transfer" /></a>` 
  : '<span class="error">Pembayaran Via TF</span>';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${formatTanggalIndonesia(item.timestamp)}</td>
          <td>${item.nama || ""}</td>
          <td>${item.uraian || ""}</td>
          <td>${item.pos || ""}</td>
          <td>${nominal ? formatRupiah(nominal) : ""}</td>
          <td>${fotoNota}</td>
          <td>${item.pembayaran || ""}</td>
          <td>${buktitransfer}</td>
<td>
  <div class="flex gap-1">
<button class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded"
  onclick='openEditModal(${JSON.stringify(item)})'>✏️Edit</button>
    <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded"
      onclick='deleteRow(${item.row})'>🗑️Hapus</button>
  </div>
</td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("totalNominal").textContent = `Total Nominal: ${formatRupiah(totalNominal)}`;
    }

    function filterByPos(pos) {
      let filtered = allData;
      if (pos) filtered = allData.filter(item => item.pos === pos);
      renderTable(filtered);
    }

    function filterByDate() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      if (!startDate || !endDate) {
        renderTable(allData);
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);

      const filtered = allData.filter(item => {
        const timestamp = new Date(item.timestamp);
        return timestamp >= start && timestamp <= end;
      });

      renderTable(filtered);
    }

    function filterCurrentMonthData() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const filtered = allData.filter(item => {
        const date = new Date(item.timestamp);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
      });
      renderTable(filtered);
    }

    function resetFilter() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      renderTable(allData);
    }
    function toDateTimeLocalInput(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      if (isNaN(d)) return '';
      // create yyyy-mm-ddThh:ii
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
function formatTanggalIndonesia(datetimeStr) {
  const date = new Date(datetimeStr);
  if (isNaN(date)) return datetimeStr;
  const pad = n => n.toString().padStart(2, '0');
  return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
}    
// ✅ Saat buka modal
function openEditModal(item) {
  selectedItem = { ...item }; // langsung pakai row asli dari fetchData
  document.getElementById("editRow").value = selectedItem.row;
  document.getElementById("editTimestamp").value = formatTanggalIndonesia(item.timestamp);
  document.getElementById("editNama").value = item.nama || "";
  document.getElementById("editUraian").value = item.uraian || "";
  document.getElementById("editPos").value = item.pos || "";
  document.getElementById("editNominal").value = item.nominal || "";
  document.getElementById("editPembayaran").value = item.pembayaran || "Cash";
  document.getElementById("editModal").classList.remove("hidden");
}


    function closeEditModal() {
      document.getElementById("editModal").classList.add("hidden");
      selectedItem = null;
    }

    document.getElementById("editForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      if (!selectedItem) return;

      const updated = [
        document.getElementById("editTimestamp").value, 
        document.getElementById("editNama").value,
        document.getElementById("editUraian").value,
        document.getElementById("editPos").value,
        document.getElementById("editNominal").value,
        selectedItem.foto || "",
        document.getElementById("editPembayaran").value,
        selectedItem.buktitransfer || ""
      ];

      const res = await fetch(`${API_ENDPOINT}?id_spreadsheet=${id_spreadsheet}`, {
        method: "POST",
        body: JSON.stringify({
          action: "edit",
          sheet: "Transaksi",
          payload: { row: selectedItem.row, values: updated }
        })
      });

      const result = await res.json();
      if (result.status === "success") {
        alert("Data berhasil diupdate!");
        closeEditModal();
        fetchData();
      } else {
        alert("Gagal update data!");
      }
    });
async function deleteRow(row) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;

  try {
    const res = await fetch(`${API_ENDPOINT}?id_spreadsheet=${id_spreadsheet}`, {
      method: "POST",
      body: JSON.stringify({
        action: "delete",
        sheet: "Transaksi",
        payload: { row: row,   }
      })
    });

    const result = await res.json();
    if (result.status === "success") {
      alert("Data berhasil dihapus!");
      fetchData(); // refresh tabel
    } else {
      alert("Gagal menghapus data!");
    }
  } catch (err) {
    console.error(err);
    alert("Terjadi error saat menghapus data!");
  }
}    
    document.getElementById("filterBtn").addEventListener("click", filterByDate);
    document.getElementById("resetBtn").addEventListener("click", resetFilter);

    fetchData();
    fetchPos();
  </script>
</body>
</html>
