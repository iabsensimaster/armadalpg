<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>i-Armada | Grafik Perawatan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f9fafb; }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      padding: 1.5rem;
      transition: transform .3s ease, box-shadow .3s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    canvas {
      transition: opacity 0.6s ease;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-6 space-y-6">

  <!-- ðŸ”¹ Header -->
  <div class="text-center mt-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">ðŸ“Š Grafik Perawatan Armada</h1>
    <p class="text-gray-600">Pantau biaya perawatan per armada & jenis perawatan setiap bulan</p>
  </div>

  <!-- ðŸ”¹ Filter -->
  <div class="card w-full max-w-4xl flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="flex flex-col">
      <label for="selectArmada" class="text-gray-700 font-semibold mb-1">Pilih Armada / Plat Nomor:</label>
      <select id="selectArmada" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none w-64">
        <option value="">-- Pilih Armada --</option>
      </select>
    </div>

    <button id="btnRefresh" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-md">
      ðŸ”„ Muat Ulang Data
    </button>
  </div>

  <!-- ðŸ”¹ Grafik -->
  <div class="card w-full max-w-5xl">
    <canvas id="grafikPerawatan" height="160"></canvas>
  </div>

  <!-- ðŸ”¹ Info Ringkas -->
  <div id="info" class="card w-full max-w-4xl text-center text-gray-700 text-sm"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxzIMwbvmewC-xhFAWZSHxkypF9Kcq2_kCw-v2Q-auXhUvWr3qQ3yzC2ThDjwvnRrzJ/exec";
    const id_spreadsheet = localStorage.getItem("id_spreadsheet");

    const ctx = document.getElementById("grafikPerawatan").getContext("2d");
    let chart;

    const warna = {
      "SERVICE": "#2563eb",
      "GANTI OLI": "#f59e0b",
      "GANTI BAN": "#10b981",
      "GANTI KOPLING": "#8b5cf6",
      "STNK": "#ef4444",
      "PAJAK": "#14b8a6",
      "KIR": "#3b82f6"
    };

    async function ambilData() {
      const res = await fetch(`${API_URL}?id_spreadsheet=${id_spreadsheet}&action=getGrafikBulanan`);
      return await res.json();
    }

    async function init() {
      const data = await ambilData();

      // ðŸ”¹ Ambil daftar armada unik
      const armadas = new Set();
      data.forEach(d => Object.keys(d.armada).forEach(a => armadas.add(a)));

      const select = document.getElementById("selectArmada");
      select.innerHTML = `<option value="">-- Pilih Armada --</option>`;
      [...armadas].forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        select.appendChild(opt);
      });

      select.addEventListener("change", () => tampilGrafik(data, select.value));
      document.getElementById("btnRefresh").addEventListener("click", () => init());

      // auto tampilkan armada pertama
      if (armadas.size > 0) tampilGrafik(data, [...armadas][0]);
    }

    function tampilGrafik(data, armada) {
      if (!armada) return;

      const labels = data.map(d => d.bulan);
      const jenisPerawatan = ["SERVICE", "GANTI OLI", "GANTI BAN", "GANTI KOPLING", "STNK", "PAJAK", "KIR"];

      const datasets = jenisPerawatan.map(jenis => ({
        label: jenis,
        data: data.map(d => d.armada[armada]?.[jenis] || 0),
        backgroundColor: warna[jenis] + "aa",
        borderColor: warna[jenis],
        borderWidth: 1
      }));

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          animation: {
            duration: 1200,
            easing: "easeOutQuart"
          },
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: `Grafik Perawatan Armada: ${armada}` }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: v => "Rp " + v.toLocaleString("id-ID") }


      // ðŸ”¹ Tambahkan daftar tanggal perawatan di bawah grafik
  let detailHTML = `<div class="mt-4 text-left">
    <h3 class="font-semibold text-gray-800 mb-2">ðŸ“… Rincian Tanggal Perawatan (${armada})</h3>
    <ul class="text-sm text-gray-700 space-y-1">`;

  jenisPerawatan.forEach(jenis => {
    const tanggalList = [];

    data.forEach(d => {
      if (d.armada[armada] && d.armada[armada][jenis]) {
        // Ambil tanggal asli transaksi dari data (kalau disediakan Apps Script)
        if (d.tanggalList && d.tanggalList[armada] && d.tanggalList[armada][jenis]) {
          d.tanggalList[armada][jenis].forEach(tgl => tanggalList.push(tgl));
        }
      }
    });

    if (tanggalList.length > 0) {
      detailHTML += `<li><b>${jenis}</b> â†’ ${tanggalList.join(", ")}</li>`;
    }
  });

  detailHTML += `</ul></div>`;
  document.getElementById("info").innerHTML += detailHTML;

            }
          }
        }
      });

      

      // Update info ringkas
      const total = data.reduce((sum, d) => {
        const perArmada = d.armada[armada];
        if (perArmada) Object.values(perArmada).forEach(v => sum += v);
        return sum;
      }, 0);
      document.getElementById("info").innerHTML =
        `<b>Total Biaya ${armada}</b>: Rp ${total.toLocaleString("id-ID")} (Semua jenis perawatan)`;
    }

    init();
  </script>
</body>
</html>
